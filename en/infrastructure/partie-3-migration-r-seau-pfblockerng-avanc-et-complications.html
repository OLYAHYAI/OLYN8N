<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Part 3 – Network Migration, Advanced Pfblockerng, and Complications - Technical tutorial and guide">
    <meta name="keywords" content="homelab">
    <meta name="author" content="OLYAHYAI">

    <title>Part 3 – Network Migration, Advanced Pfblockerng, and Complications | Omar LYAHYAI Technical Blog</title>

    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/blog.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="dark-theme">
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <header class="header" role="banner">
        <nav class="navbar" role="navigation" aria-label="Main navigation">
            <div class="container">
                <div class="nav-brand">
                    <a href="/index.html" class="logo">
                        <i class="fas fa-terminal"></i>
                        <span>OLYAHYAI</span>
                    </a>
                </div>

                <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
                    <span class="hamburger"></span>
                </button>

                <ul class="nav-menu">
                    <li><a href="/index.html#home" class="nav-link">Home</a></li>
                    <li><a href="/index.html#about" class="nav-link">About</a></li>
                    <li><a href="/index.html#projects" class="nav-link">Projects</a></li>
                    <li><a href="/index.html#skills" class="nav-link">Skills</a></li>
                    <li><a href="/blog/index.html" class="nav-link active">Blog</a></li>
                    <li><a href="/index.html#contact" class="nav-link">Contact</a></li>
                </ul>

                <div class="nav-actions">
                    <a href="/fr/infrastructure/partie-3-migration-r-seau-pfblockerng-avanc-et-complications.html" class="lang-toggle" aria-label="Change language">
                        <span class="lang-current">FR</span>
                        <i class="fas fa-globe"></i>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main id="main-content">
        <section class="article-header" role="region" aria-label="Article header">
            <div class="container">
                <div class="article-breadcrumb">
                    <nav class="breadcrumb" aria-label="Breadcrumb">
                        <a href="/index.html">Home</a>
                        <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
                        <a href="/blog/index.html">Blog</a>
                        <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
                        <a href="/blog/infrastructure.html">Infrastructure</a>
                        <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
                        <span>Part 3 – Network Migration, Advanced Pfblockerng, and Complications</span>
                    </nav>
                </div>

                <h1 class="article-title">Part 3 – Network Migration, Advanced Pfblockerng, and Complications</h1>

                <div class="article-meta">
                    <div class="article-meta-item">
                        <i class="far fa-calendar"></i>
                        <span>2025-11-19</span>
                    </div>
                    <div class="article-meta-item">
                        <i class="far fa-clock"></i>
                        <span>5 min min read</span>
                    </div>
                    <div class="article-meta-item">
                        <i class="fas fa-folder"></i>
                        <span>Infrastructure</span>
                    </div>
                    <div class="article-meta-item">
                        <i class="fas fa-tags"></i>
                        <span>homelab</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="article-content" role="region" aria-label="Article content">
            <div class="container">
                <div class="article-body">
                    <!-- 
TEMPLATE - Press Alt+E to apply

UPDATE THESE FIELDS:
- title: "Your Title" (KEEP QUOTES)
- date: "YYYY-MM-DD" (KEEP QUOTES)
- category: infrastructure/network_security/automation_ai/reference
- language: auto (let workflow detect) | en (force English) | fr (force French)
- tags: single-keyword-only (NO COMMAS! Use one word or hyphenated)
- description: "Short summary" (KEEP QUOTES)

CRITICAL RULES:
✅ DO: Keep quotes around title, date, description
✅ DO: Use "auto" for language to let workflow detect from content
✅ DO: Use single word for tags (homelab, pfsense, proxmox)
❌ DON'T: Use commas in tags (breaks YAML!)
❌ DON'T: Remove quotes from title/date/description

The workflow will:
- Detect language automatically from your content
- Generate English + French versions
- Create full HTML with navigation
- Preserve images and links
-->
<!-- 
TEMPLATE - Press Alt+E to apply

UPDATE THESE FIELDS:
- title: "Your Title" (KEEP QUOTES)
- date: "YYYY-MM-DD" (KEEP QUOTES)
- category: infrastructure/network_security/automation_ai/reference
- language: auto (let workflow detect) | en (force English) | fr (force French)
- tags: single-keyword-only (NO COMMAS! Use one word or hyphenated)
- description: "Short summary" (KEEP QUOTES)

CRITICAL RULES:
✅ DO: Keep quotes around title, date, description
✅ DO: Use "auto" for language to let workflow detect from content
✅ DO: Use single word for tags (homelab, pfsense, proxmox)
❌ DON'T: Use commas in tags (breaks YAML!)
❌ DON'T: Remove quotes from title/date/description

The workflow will:
- Detect language automatically from your content
- Generate English + French versions
- Create full HTML with navigation
- Preserve images and links
-->
<!-- 
TEMPLATE - Press Alt+E to apply

UPDATE THESE FIELDS:
- title: "Your Title" (KEEP QUOTES)
- date: "YYYY-MM-DD" (KEEP QUOTES)
- category: infrastructure/network_security/automation_ai/reference
- language: auto (let workflow detect) | en (force English) | fr (force French)
- tags: single-keyword-only (NO COMMAS! Use one word or hyphenated)
- description: "Short summary" (KEEP QUOTES)

CRITICAL RULES:
✅ DO: Keep quotes around title, date, description
✅ DO: Use "auto" for language to let workflow detect from content
✅ DO: Use single word for tags (homelab, pfsense, proxmox)
❌ DON'T: Use commas in tags (breaks YAML!)
❌ DON'T: Remove quotes from title/date/description

The workflow will:
- Detect language automatically from your content
- Generate English + French versions
- Create full HTML with navigation
- Preserve images and links
-->
<!-- 
TEMPLATE - Press Alt+E to apply

UPDATE THESE FIELDS:
- title: "Your Title" (KEEP QUOTES)
- date: "YYYY-MM-DD" (KEEP QUOTES)
- category: infrastructure/network_security/automation_ai/reference
- language: en or fr
- tags: single-keyword-only (NO COMMAS! Use one word or hyphenated)
- description: "Short summary" (KEEP QUOTES)

CRITICAL RULES:
✅ DO: Keep quotes around title, date, description
✅ DO: Use single word for tags (homelab, pfsense, proxmox)
❌ DON'T: Use commas in tags (breaks YAML!)
❌ DON'T: Remove quotes from title/date/description

EXAMPLES OF VALID TAGS:
- tags: homelab
- tags: pfsense
- tags: networking
- tags: cybersecurity

The workflow will:
- Generate English + French versions
- Create full HTML with navigation
- Preserve images and links
-->
<!-- 
TEMPLATE - Press Alt+E to apply

UPDATE THESE FIELDS:
- title: "Your Title" (KEEP QUOTES)
- date: "YYYY-MM-DD" (KEEP QUOTES)
- category: infrastructure/network_security/automation_ai/reference
- language: en or fr
- tags: keyword1, keyword2
- description: "Short summary" (KEEP QUOTES)

RULES:
✅ DO: Keep quotes around title, date, description
✅ DO: Use status: published (for website) or draft (work only)
❌ DON'T: Remove quotes from title/date/description
❌ DON'T: Use special characters without quotes

The workflow will:
- Generate English + French versions
- Create full HTML with navigation
- Preserve images and links
-->
<!-- 
NAMING CONVENTION:
- For English articles: your-article-title.md
- For French articles: your-article-title-fr.md

The workflow will automatically:
- Detect language from filename
- Generate title from filename
- Add current date
- Clean YAML for Pandoc processing
-->
<hr />
<h2 id="contexte">Context</h2>
<p>This part describes the complete migration of the Proxmox/VM network infrastructure to the pfSense subnet, the advanced configuration of IP/DNS filtering with pfBlockerNG, the management of technical complications, and the solutions found for each issue, keeping all real IP addresses masked.</p>
<hr />
<h2 id="étapes-réalisées">Steps Completed</h2>
<h3 id="sauvegarde-et-préparation">1. Backup and Preparation</h3>
<ul>
<li>Manual backup of the pfSense <code>.xml</code> configuration file before any migration.</li>
<li>Inventory and documentation of existing IP addresses.</li>
<li>Stopping critical services on VMs (e.g., n8n) before network modification.</li>
</ul>
<hr />
<h3 id="configuration-avancée-pfblockerng">2. Advanced pfBlockerNG Configuration</h3>
<ul>
<li><strong>IP Blocking (Inbound Only):</strong>
<ul>
<li>Enabling pfBlockerNG only on the WAN interface, Block action.</li>
<li>Adding a PRI1 set with 9 recognized sources (FeodoTracker, CINSArmy, ET, ISC, Spamhaus, Blocklist.de, URLhaus…).</li>
<li>Problem: automatic creation of rules on LAN → network blockage.</li>
<li><strong>Solution:</strong> Deletion of LAN/outbound in the general config, manual deletion of rules on LAN. Only rules on WAN (inbound) are kept.</li>
</ul></li>
<li><strong>GeoIP Blocking:</strong>
<ul>
<li>Disabled for all countries, decision made to analyze logs for several days before applying any geolocalized blocking.</li>
</ul></li>
</ul>
<hr />
<h3 id="mise-en-place-dnsbl-retours-dexpérience">3. DNSBL Implementation &amp; Lessons Learned</h3>
<ul>
<li><strong>Problem: choice of DNSBL VIP IP</strong>
<ul>
<li>Attempting several IPs in the LAN subnet was rejected by pfBlockerNG (“Address must be in an isolated Range”).</li>
<li>Attempt with an IP outside /24 (failure: not routed).</li>
<li><strong>Temporary Solution:</strong> Using 127.0.0.1 (loopback) as the DNSBL VIP → accepted by pfBlockerNG and functional in this context.</li>
</ul></li>
<li><strong>Configured DNSBL Groups:</strong>
<ul>
<li>Ads_Basic (StevenBlack hosts)</li>
<li>Ads_EasyList (compatible format only, not the original easyprivacy.txt)</li>
<li>Malware (URLhaus)</li>
<li>Phishing (Phishing Army)</li>
</ul></li>
<li><strong>DNSBL Whitelist Problem:</strong>
<ul>
<li>Unable to find the classic “global” whitelist.</li>
<li><strong>Troubleshooting:</strong> Adding exceptions (Microsoft, Ubuntu, Docker, Cloudflare…) directly into each group via the “Custom Domain Whitelist” section.</li>
</ul></li>
</ul>
<hr />
<h3 id="migration-proxmox-vms-vers-le-nouveau-lan">4. Migration Proxmox + VMs to the new LAN</h3>
<ul>
<li><strong>Step-by-step Orchestration:</strong>
<ol type="1">
<li>Migration of the Proxmox host first (modification of interfaces/bridge/gateway/dns).</li>
<li>Reconnection via new IP, Web access control.</li>
<li>Successive migration of VMs. For Ubuntu VMs using Netplan, switching to DHCP4 (followed by static assignment via pfSense mapping for production).</li>
</ol></li>
<li><strong>Main Tests:</strong>
<ul>
<li>Ping pfSense gateway</li>
<li>DNS test, external resolution, apt update, docker pull…</li>
<li>Validate that all pfBlockerNG rules do not block Linux repositories, Docker, or npm.</li>
</ul></li>
</ul>
<hr />
<h3 id="cas-particulier-n8n-docker-cloudflare-tunnel">5. Specific Case: n8n / Docker / Cloudflare Tunnel</h3>
<ul>
<li><strong>Problem 1: n8n inaccessible after migration</strong>
<ul>
<li>Origin: Docker n8n defaults to binding on 443 and a domain name, does not listen on 0.0.0.0, nor on HTTP via 5678.</li>
<li><strong>Solution:</strong> Reworking the <code>docker-compose.yml</code> to force binding on 0.0.0.0:5678, dropping SSL on the Docker side (managed by Cloudflare), safe reboot via <code>docker-compose down/up</code> (data retained via Docker volume).</li>
</ul></li>
<li><strong>Problem 2: Cloudflare Tunnel</strong>
<ul>
<li>Origin: tunnel pointed to outdated IP/port, and the tunnel was still configured for HTTPS.</li>
<li><strong>Solution:</strong> Modification of the Tunnel config to HTTP, new VM IP, unnecessary noTLSVerify disabled.</li>
</ul></li>
</ul>
<hr />
<h3 id="tests-post-migration">6. Post-migration Tests</h3>
<ul>
<li><strong>Accessibility</strong> :
<ul>
<li>LAN access for all services (n8n, Proxmox, pfSense WebGUI, AP).</li>
<li>External access to n8n via Cloudflare Tunnel.</li>
</ul></li>
<li><strong>pfBlockerNG Blocking</strong> :
<ul>
<li>Logs/alerts, blocked DNS queries (~35% average), no critical false positives (thanks to incremental whitelist).</li>
<li>Ping/DNS/network tests OK for all LAN VMs and hosts.</li>
</ul></li>
</ul>
<hr />
<h2 id="complications-et-solutions">Complications and Solutions</h2>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr>
<th>Issue Encountered</th>
<th>Symptom</th>
<th>Solution Applied</th>
</tr>
</thead>
<tbody>
<tr>
<td>pfBlockerNG Rule on LAN</td>
<td>LAN blocked, access lost</td>
<td>Deletion of Outbound LAN, rules manually deleted</td>
</tr>
<tr>
<td>DNSBL VIP rejected in LAN /24</td>
<td>“isolated range” error, block page ping failed</td>
<td>VIP set to 127.0.0.1 (temporary, works)</td>
</tr>
<tr>
<td>easyprivacy.txt incompatible</td>
<td>Invalid URL error</td>
<td>Substitution with domain-compatible sources</td>
</tr>
<tr>
<td>No global DNSBL whitelist</td>
<td>Inability to whitelist worldwide</td>
<td>Whitelists added to each group</td>
</tr>
<tr>
<td>n8n / Docker not accessible</td>
<td>No container listening on 5678</td>
<td>ports fixed, HTTP enabled, local SSL disabled</td>
</tr>
<tr>
<td>Cloudflare Tunnel not routed</td>
<td>HTTPS failed, incorrect internal destination</td>
<td>HTTP Area, update target URL/IP in tunnel dashboard</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="schéma-technique-masqué">Technical Diagram (Masked)</h2>
<p>[Internet] – [Box/ISP] – [pfSense][LAN] – [EW1200 AP] ==Wifi==
[Clients]</p>
<p>[Proxmox Host]–[VMs: n8n, others]</p>
<p>[Cloudflare Tunnel]</p>
<p>text</p>
<hr />
<h2 id="metrics-post-migration">Post-migration Metrics</h2>
<ul>
<li>Blocked DNS query rate: ≈ 35%</li>
<li>No notable downtime (>15 min) on critical services</li>
<li>pfBlockerNG IPv4: ~30 to 50k active blocked IPs</li>
<li>Total Time (Part 3): ≈ 3-4h</li>
<li>No false positives blocking production (only ads/trackers)</li>
</ul>
<hr />
<h2 id="prochaines-étapes-proposées">Proposed Next Steps</h2>
<ul>
<li>Daily monitoring of pfBlockerNG logs</li>
<li>Long-term load/latency validation</li>
<li>Documentation of future migrations (VLAN, IOT/Prod segmentation)</li>
<li>Expand monitoring usage (Grafana, Prometheus, etc.)</li>
</ul>
<hr />
<p><em>Written in Markdown format, Part 3 of the personalized homelab project pfsense/proxmox/cloudflare, IPs and credentials intentionally masked.</em></p>
                </div>

                <div class="article-navigation">
                </div>
            </div>
        </section>
    </main>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <h3>OLYAHYAI</h3>
                    <p>Pentester in Training | Cybersecurity Enthusiast</p>
                </div>

                <div class="footer-links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/index.html#home">Home</a></li>
                        <li><a href="/index.html#about">About</a></li>
                        <li><a href="/index.html#projects">Projects</a></li>
                        <li><a href="/blog/index.html">Blog</a></li>
                    </ul>
                </div>

                <div class="footer-social">
                    <h4>Connect</h4>
                    <div class="social-links">
                        <a href="https://github.com/OLYAHYAI" target="_blank" rel="noopener">
                            <i class="fab fa-github"></i>
                        </a>
                        <a href="https://ma.linkedin.com/in/lyahyai-omar" target="_blank" rel="noopener">
                            <i class="fab fa-linkedin"></i>
                        </a>
                        <a href="mailto:contact@olyahyai.com">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 OLYAHYAI. All rights reserved.</p>
                <p>Built with <i class="fas fa-heart"></i> and <i class="fas fa-terminal"></i></p>
            </div>
        </div>
    </footer>

    <button class="back-to-top" aria-label="Back to top">
        <i class="fas fa-chevron-up"></i>
    </button>

    <script src="../../js/main.js"></script>
    <script src="../../js/animations.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>